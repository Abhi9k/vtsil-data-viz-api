var web_worker,v1_data,v2_data,v3_data,W,H,sensor_info,sid_floor_mapping,f1_sensors,f2_sensors,f3_sensors,f4_sensors,f5_sensors;
// var sid_floor_mapping = {"216": "1", "217": "1", "214": "1", "215": "1", "212": "1", "213": "3", "210": "3", "211": "3", "165": "3", "264": "1", "218": "1", "219": "1", "133": "3", "132": "3", "131": "3", "130": "3", "137": "4", "136": "3", "135": "3", "134": "3", "139": "4", "138": "4", "225": "1", "24": "5", "25": "5", "26": "5", "27": "5", "20": "3", "21": "3", "22": "5", "23": "5", "95": "3", "28": "2", "29": "3", "222": "1", "0": "2", "4": "2", "8": "2", "96": "3", "120": "3", "121": "3", "261": "1", "123": "3", "267": "1", "125": "3", "265": "1", "127": "3", "128": "3", "129": "3", "269": "1", "268": "3", "220": "1", "91": "3", "59": "2", "58": "2", "55": "2", "54": "1", "57": "2", "56": "2", "51": "1", "52": "1", "16": "3", "146": "3", "199": "5", "198": "5", "147": "3", "195": "2", "197": "5", "144": "3", "115": "3", "114": "3", "117": "3", "116": "3", "111": "5", "110": "5", "113": "3", "253": "3", "82": "1", "83": "1", "80": "1", "81": "1", "119": "3", "87": "2", "84": "2", "85": "2", "174": "5", "207": "4", "206": "3", "226": "1", "172": "5", "3": "2", "7": "2", "92": "3", "245": "4", "244": "4", "108": "3", "109": "4", "241": "4", "240": "4", "243": "4", "242": "4", "102": "3", "103": "3", "100": "5", "249": "3", "248": "3", "104": "3", "105": "3", "39": "2", "38": "1", "33": "1", "32": "1", "270": "1", "30": "5", "37": "1", "247": "3", "35": "1", "34": "1", "246": "4", "162": "3", "252": "3", "205": "4", "60": "2", "61": "2", "258": "1", "259": "1", "97": "3", "179": "4", "178": "5", "177": "5", "176": "5", "250": "3", "251": "3", "173": "5", "257": "1", "254": "3", "255": "3", "106": "3", "175": "5", "107": "3", "182": "4", "183": "4", "180": "4", "181": "4", "186": "4", "187": "4", "184": "4", "185": "4", "202": "5", "6": "2", "99": "3", "98": "3", "168": "4", "169": "3", "229": "3", "228": "1", "227": "1", "90": "2", "166": "3", "224": "3", "223": "1", "161": "3", "221": "1", "163": "3", "11": "2", "10": "2", "13": "2", "15": "3", "14": "2", "17": "3", "271": "3", "19": "3", "18": "3", "143": "4", "88": "2", "89": "2", "31": "1", "151": "3", "150": "3", "153": "3", "152": "3", "155": "3", "154": "3", "157": "3", "156": "3", "158": "3", "112": "3", "36": "1", "238": "4", "239": "4", "234": "4", "235": "4", "236": "4", "237": "4", "230": "1", "231": "1", "232": "1", "233": "4", "49": "3", "46": "2", "86": "2", "44": "2", "45": "2", "42": "2", "43": "2", "40": "2", "118": "3", "1": "2", "5": "2", "9": "2", "201": "4", "200": "5", "203": "5", "145": "3", "142": "4", "204": "5", "140": "4", "141": "5", "209": "3", "208": "4", "148": "3", "149": "3", "77": "1", "76": "1", "75": "1", "74": "1", "79": "1", "78": "1", "2": "2", "263": "1", "262": "1", "122": "3", "41": "1", "260": "1", "47": "2", "124": "3", "126": "3", "266": "1"};
// var f1_sensors = ["216", "217", "214", "215", "212", "218", "219", "261", "267", "265", "264", "269", "54", "51", "52", "259", "82", "83", "80", "81", "38", "33", "32", "270", "37", "36", "34", "223", "258", "257", "228", "226", "225", "222", "221", "220", "31", "35", "230", "231", "232", "41", "77", "76", "75", "74", "79", "78", "263", "262", "227", "260", "266"].sort(function(a,b){return +a-+b});
// var f2_sensors = ["28", "0", "4", "8", "87", "59", "58", "55", "57", "56", "90", "195", "86", "84", "3", "7", "39", "60", "61", "2", "6", "11", "10", "13", "14", "88", "89", "46", "47", "44", "45", "42", "43", "40", "1", "5", "9", "85"].sort(function(a,b){return +a-+b});
// var f3_sensors = ["213", "210", "211", "165", "127", "133", "132", "131", "130", "136", "135", "134", "20", "21", "95", "29", "96", "119", "120", "121", "123", "125", "128", "129", "268", "161", "146", "147", "115", "114", "117", "116", "113", "118", "108", "206", "92", "166", "247", "102", "103", "249", "248", "104", "105", "271", "252", "253", "250", "251", "254", "255", "162", "106", "107", "97", "99", "98", "163", "169", "229", "91", "224", "15", "17", "16", "19", "18", "151", "150", "153", "152", "155", "154", "157", "156", "158", "112", "49", "144", "145", "209", "148", "149", "122", "124", "126"].sort(function(a,b){return +a-+b});
// var f4_sensors = ["137", "139", "138", "143", "207", "245", "244", "109", "241", "240", "243", "242", "246", "181", "179", "182", "183", "180", "186", "187", "184", "185", "142", "168", "239", "238", "234", "235", "236", "237", "233", "201", "205", "140", "208"].sort(function(a,b){return +a-+b});
// var f5_sensors = ["24", "25", "26", "27", "22", "23", "199", "198", "197", "178", "203", "111", "110", "176", "174", "173", "172", "30", "177", "175", "202", "100", "200", "204", "141"].sort(function(a,b){return +a-+b});
var is_first=true;
var MIN_POWER=0.0000000000000000000009;
var MAX_POWER=0.0009
function onWebWorkerMessage(event) {
    msg=event.data;
    if(msg[0]==='data') {
        if(v3_data===undefined) {
            v3_data=[];
        }
        v3_data.push(msg[1]['v1'][0]);
        if(v3_data.length>60*30)
            v3_data.shift();
        v1_data = msg[1]['v1'][0];
        v2_data = msg[1]['v2'];
        if(is_first===true){
            drawV1();
            drawV3();
            drawV2();
            is_first=false;
        }else {
            drawV1();
            updateV3();
            drawV2();
        }
    }

    if(msg[0]==='sensorInfo') {
        sensor_info = msg[1];
        sids = Object.keys(sensor_info);
        sid_floor_mapping={}
        f1_sensors=[],f2_sensors=[],f3_sensors=[],f4_sensors=[],f5_sensors=[];
        var sensors=[f1_sensors, f2_sensors, f3_sensors, f4_sensors, f5_sensors];
        for(sid in sids){
            if(sensor_info[sid]['floor']!=='') {
                sid_floor_mapping[sid]=sensor_info[sid]['floor'];
                sensors[+sensor_info[sid]['floor'] - 1].push(String(sid));
            }
        }
        for(var i=0;i<sensors.length;i++)
            sensors[i]=sensors[i].sort(function(a,b){return +a-+b});

    }
}

function startWebWorker() {
    if(typeof(Worker) !== "undefined") {
        if(typeof(web_worker) == "undefined") {
            web_worker = new Worker("js/webWorker.js");
        }
        web_worker.onmessage = onWebWorkerMessage;
    } else {}
}

// function getDimensions(id) {
//     let width = document.getElementById(id).getBoundingClientRect().width;
//     let height = document.getElementById(id).getBoundingClientRect().height;
//     let y = document.getElementById(id).getBoundingClientRect().y;
//     let x = document.getElementById(id).getBoundingClientRect().x;
//     return [width,height,x,y];
// }

function getSVGElementCenter(box) {
    return [box.width/2 + box.x, box.height/2 + box.y];
}

startWebWorker();

// (function updateVisualization() {
//     web_worker.postMessage(['updateData']);
//     web_worker.postMessage(['sensorInfo']);
// })();

window.addEventListener("DOMContentLoaded", function() {
    initV2();
    initV1();
    initV3();
    W = window.innerWidth;
    H = window.innerHeight;
    initInteraction();
    // web_worker.postMessage(['updateData']);
    web_worker.postMessage(['sensorInfo']);
    update();
});



function update() {
    web_worker.postMessage(['updateData']);
    setTimeout(update, 1000);
}